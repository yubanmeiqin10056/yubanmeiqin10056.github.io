name: Auto Add Front Matter to New Articles

on:
  push:
    branches: [ main ]
    paths: 
      - '_articles/**/*.md'
      - '_articles/**/*.markdown'

jobs:
  check-and-add-front-matter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # 获取完整历史以便推送

    - name: Add front matter to articles without it
      run: |
        #!/bin/bash
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        # 遍历 _articles 目录中的所有 markdown 文件
        find _articles -name "*.md" -type f -o -name "*.markdown" -type f | while read -r file; do
          # 检查文件是否已经包含 front matter
          if [ -f "$file" ]; then
            # 检查前3行是否有至少两个 '---' 行（front matter 的开头和结尾）
            front_matter_lines=$(head -n 3 "$file" 2>/dev/null | grep -c '^--- || echo 0)
            
            if [ "$front_matter_lines" -lt 2 ]; then
              echo "Adding front matter to: $file"
              
              # 创建临时文件并添加 front matter
              temp_file=$(mktemp)
              echo "---" > "$temp_file"
              echo "layout: post" >> "$temp_file"
              echo "---" >> "$temp_file"
              echo "" >> "$temp_file"
              cat "$file" >> "$temp_file"
              mv "$temp_file" "$file"
            else
              echo "File already has front matter: $file"
            fi
          fi
        done
        
        # 检查是否有更改并提交
        if [ -n "$(git status --porcelain)" ]; then
          git add .
          git commit -m "Auto-add front matter to articles [skip ci]" -m "Automatically added required front matter to articles that were missing it."
          git push
        else
          echo "No changes to commit"
        fi