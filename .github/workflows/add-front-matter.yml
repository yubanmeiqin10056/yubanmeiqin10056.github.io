name: Add Front Matter to New Articles

on:
  push:
    branches: [ main ]
    paths: 
      - '_articles/**/*.md'
      - '_articles/**/*.markdown'

jobs:
  add-front-matter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2  # 获取足够的历史记录来比较更改

    - name: Check for files without front matter
      run: |
        # 安装必要的工具
        pip3 install PyYAML
        
        # 创建 Python 脚本来检查并添加 front matter
        cat > add_front_matter.py << 'EOF'
import os
import glob
import re

def has_front_matter(content):
    """检查文件是否包含 front matter"""
    lines = content.split('\n')
    if len(lines) < 3:
        return False
    # 检查是否以 --- 开头，并且在内容中有另一个 ---
    if lines[0].strip() == '---':
        for i in range(1, len(lines)):
            if lines[i].strip() == '---':
                return True
    return False

def add_front_matter(file_path):
    """为没有 front matter 的文件添加最小的 front matter"""
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    if not has_front_matter(content):
        # 添加最小的 front matter
        new_content = '---\nlayout: post\n---\n\n' + content
        
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(new_content)
        
        print(f"Added front matter to: {file_path}")
        return True
    else:
        print(f"File already has front matter: {file_path}")
        return False

# 查找 _articles 目录下的所有 markdown 文件
article_files = glob.glob('_articles/**/*.md', recursive=True) + glob.glob('_articles/**/*.markdown', recursive=True)

updated_files = []
for file_path in article_files:
    try:
        if add_front_matter(file_path):
            updated_files.append(file_path)
    except Exception as e:
        print(f"Error processing {file_path}: {e}")

if updated_files:
    print(f"Updated {len(updated_files)} files: {updated_files}")
    # 设置环境变量，供后续步骤使用
    with open(os.environ['GITHUB_ENV'], 'a') as f:
        f.write(f"UPDATED_FILES={','.join(updated_files)}\n")
else:
    print("No files needed front matter added")
    with open(os.environ['GITHUB_ENV'], 'a') as f:
        f.write("UPDATED_FILES=\n")
EOF

    - name: Run front matter script
      run: python3 add_front_matter.py

    - name: Commit and push changes if files were updated
      run: |
        if [ -n "$UPDATED_FILES" ] && [ "$UPDATED_FILES" != "UPDATED_FILES=" ]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "自动为新文章添加 front matter [skip ci]" || exit 0
          git push
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}